<!doctype html>
<html lang="de">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>German BNF</title>
<style>
  :root{--bg:#0f1724;--card:#0b1220;--accent:#7c3aed;color-scheme:dark}
  html,body{height:100%;margin:0;background:linear-gradient(180deg,#071021 0%,#071428 100%);font-family:Inter, Roboto, Arial, sans-serif;color:#e6eef8}
  .wrap{max-width:1100px;margin:28px auto;padding:20px}
  header{display:flex;gap:16px;align-items:center}
  h1{margin:.2rem 0;font-size:1.4rem}
  .grid{display:grid;grid-template-columns:360px 1fr;gap:16px;margin-top:16px}
  .sidebar{background:var(--card);padding:12px;border-radius:12px;overflow:auto;max-height:75vh}
  .main{background:rgba(255,255,255,0.02);padding:12px;border-radius:12px;max-height:75vh;overflow:auto}
  .bnf-rule{margin:8px 0;padding:8px;border-radius:8px}
  .nonterm{color:var(--accent);cursor:pointer;text-decoration:underline}
  .terminal{color:#9fe3c1;cursor:pointer}
  .search{display:flex;gap:8px;margin-bottom:8px}
  input[type=text]{flex:1;padding:8px;border-radius:8px;border:1px solid rgba(255,255,255,0.06);background:transparent;color:inherit}
  button{padding:8px 10px;border-radius:8px;border:0;background:var(--accent);color:#041121;cursor:pointer}
  .modal{position:fixed;inset:0;background:rgba(2,6,23,0.6);display:flex;align-items:center;justify-content:center;visibility:hidden;opacity:0;transition:all .18s}
  .modal.open{visibility:visible;opacity:1}
  .card{background:#031028;padding:18px;border-radius:12px;max-width:720px;width:100%;box-shadow:0 8px 30px rgba(0,0,0,0.6)}
  .lex-row{display:flex;gap:12px;align-items:flex-start;margin:8px 0}
  .flexions{font-family:monospace;background:#021827;padding:8px;border-radius:8px}
  footer{margin-top:12px;font-size:0.8rem;color:#9fb0c9}
  .bnf-title{font-weight:600;margin:6px 0}
  .defs{padding-left:10px}
  .kbd{font-family:monospace;background:#021827;padding:2px 6px;border-radius:6px}
</style>
</head>
<body>
<div class="wrap">
  <header>
    <div>
      <h1>German BNF</h1>
      <div style="font-size:.9rem;color:#9fb0c9">Click nonterminals to jump to definitions. Click terminals to open dictionary entries (sample lexicon included).</div>
    </div>
  </header>
  <div class="grid">
    <aside class="sidebar">
      <div class="search">
        <input id="search" placeholder="Find nonterminal or word (type &quot;NP&quot; or &quot;Haus&quot;)" />
        <button id="clear">Clear</button>
      </div>
      <div class="bnf-index">
        <div class="bnf-title">Index (nonterminals)</div>
        <div id="indexList"></div>
      </div>
      <hr style="opacity:.06;margin:10px 0">
      <div class="bnf-title">Lexicon (sample)</div>
      <div id="lexList" style="max-height:36vh;overflow:auto"></div>
      <hr style="opacity:.06;margin:10px 0">
      <div style="font-size:.85rem">Tips: paste a larger JSON lexicon into the textarea below to extend to ~2k terminals.</div>
      <textarea id="lexImport" placeholder='Paste JSON lexicon here (array)' style="width:100%;height:90px;margin-top:8px;background:#020b12;color:#cde6f0;border-radius:6px;padding:8px"></textarea>
      <button id="importLex">Import lexicon</button>
    </aside>
    <main class="main">
      <section id="bnfArea"></section>
      <footer>
        <div>Export: copy the whole HTML into a new CodePen. Import your lexicon JSON to extend terminals.</div>
      </footer>
    </main>
  </div>
</div>

<div class="modal" id="modal">
  <div class="card">
    <div style="display:flex;justify-content:space-between;align-items:center">
      <div id="modalTitle" style="font-size:1.1rem;font-weight:600"></div>
      <button id="close">Close</button>
    </div>
    <div style="margin-top:8px" id="modalBody"></div>
  </div>
</div>

<script>
let lexicon = [];
let cfg = [];

// Load lexicon
function loadLexicon(){
    fetch('lexicon.json')
    .then(r=>r.ok ? r.json() : Promise.reject('Network error'))
    .then(d=>{
        lexicon = d.data || [];
        renderIndex();
        renderLex();
    })
    .catch(e=>{ console.error(e); lexicon=[]; renderIndex(); renderLex(); });
}

// Load CFG from cfg.json
function loadCFG(){
    fetch('cfg.json')
    .then(r=>r.ok ? r.json() : Promise.reject('Network error'))
    .then(d=>{
        cfg = d.data || [];
        renderCFG();
        renderIndex();
    })
    .catch(e=>{ console.error('Error loading CFG:', e); });
}

// Render CFG into BNF area
function renderCFG(){
    const area = document.getElementById('bnfArea');
    if(!area) return;
    area.innerHTML='';
    cfg.forEach(rule=>{
        const div = document.createElement('div');
        div.className='bnf-rule';
        div.id = rule.nonterminal;
        const rhs = rule.productions.map(seq=>{
            return seq.map(s=>{
                if(typeof s==='string'){
                    if(s.startsWith('<') && s.endsWith('>')){
                        return `<span class="nonterm" data-n="${s.slice(1,-1)}">${s}</span>`;
                    } else {
                        return `<span class="terminal" data-w="${s}">${s}</span>`;
                    }
                } else if(s.optional){
                    return `[<span class="nonterm" data-n="${s.optional}">${s.optional}</span>]`;
                } else if(s.repeat){
                    return `{<span class="nonterm" data-n="${s.repeat}">${s.repeat}</span>}`;
                } else if(s.anyOf){
                    return `(${s.anyOf.map(a=>'<span class="nonterm" data-n="'+a+'">'+a+'</span>').join(' | ')})`;
                }
                return s;
            }).join(' ');
        }).join(' | ');
        div.innerHTML = `<span class="nonterm" data-n="${rule.nonterminal}">&lt;${rule.nonterminal}&gt;</span> ::= ${rhs}`;
        area.appendChild(div);
    });
}

// Render lexicon sidebar
function renderLex(){
    const el = document.getElementById('lexList');
    if(!el) return; el.innerHTML='';
    lexicon.forEach(entry=>{
        const d = document.createElement('div');
        d.className='lex-row';
        d.innerHTML = `<div style="flex:1"><a class="terminal" data-w="${entry.word}">${entry.word}</a> <span style="opacity:.7">(${entry.pos})</span></div><div class="flexions">${entry.flexions||''}</div>`;
        el.appendChild(d);
    });
}

// Render nonterminal index
function renderIndex(){
    const idx = document.getElementById('indexList');
    if(!idx) return;
    idx.innerHTML='';
    const nonterms = cfg.map(r=>r.nonterminal);
    nonterms.forEach(n=>{
        const el = document.createElement('div');
        el.innerHTML = `<a class="nonterm" data-n="${n}" style="cursor:pointer;color:var(--accent);text-decoration:underline">&lt;${n}&gt;</a>`;
        idx.appendChild(el);
    });
}

// Show dictionary modal
function showModal(word){
    const m = document.getElementById('modal');
    const t = document.getElementById('modalTitle');
    const b = document.getElementById('modalBody');
    if(!m||!t||!b) return;
    m.classList.add('open');
    const ent = lexicon.find(e=>e.word===word);
    if(!ent){ t.textContent=word; b.innerHTML='<div style="opacity:.7">No dictionary entry found.</div>'; return; }
    t.textContent = `${ent.word} — /${ent.ipa||''}/`;
    b.innerHTML = `<div style="margin-top:8px"><strong>POS:</strong> ${ent.pos||''}</div>
                   <div style="margin-top:8px"><strong>Flexions:</strong><div class="flexions" style="margin-top:6px">${ent.flexions||'—'}</div></div>
                   <div style="margin-top:8px"><strong>Meanings:</strong><ol>${(ent.meanings||[]).map(m=>`<li>${m}</li>`).join('')}</ol></div>`;
}

// Init
document.addEventListener('DOMContentLoaded', function(){
    loadLexicon();
    loadCFG();

    document.addEventListener('click', function(e){
        if(e.target.matches('.nonterm')){
            const n = e.target.dataset.n;
            const el = document.getElementById(n);
            if(el){ el.scrollIntoView({behavior:'smooth',block:'center'}); el.style.boxShadow='0 0 0 3px rgba(124,58,237,0.12)'; setTimeout(()=>el.style.boxShadow='none',600); }
        }
        if(e.target.matches('.terminal')){
            const w = e.target.dataset.w;
            showModal(w);
        }
    });

    const closeBtn = document.getElementById('close');
    if(closeBtn) closeBtn.addEventListener('click',()=>document.getElementById('modal').classList.remove('open'));

    const search = document.getElementById('search');
    const clearBtn = document.getElementById('clear');
    if(clearBtn) clearBtn.addEventListener('click',()=>{ if(search) search.value=''; search.dispatchEvent(new Event('input')); });
    if(search) search.addEventListener('input',function(){
        const q = this.value.trim().toLowerCase();
        document.querySelectorAll('.bnf-rule').forEach(r=>{ r.style.display='block'; r.style.opacity=1; });
        document.querySelectorAll('.nonterm').forEach(nt=>{ nt.style.background='none'; });
        if(!q) return;
        document.querySelectorAll('.nonterm').forEach(nt=>{ if(nt.dataset.n.toLowerCase().includes(q)) nt.style.background='rgba(124,58,237,0.12)'; });
        document.querySelectorAll('.bnf-rule').forEach(r=>{ if(!r.textContent.toLowerCase().includes(q)) r.style.display='none'; });
    });

    // Import lexicon
    const importBtn = document.getElementById('importLex');
    if(importBtn) importBtn.addEventListener('click', function(){
        const txtArea = document.getElementById('lexImport');
        if(!txtArea) return;
        const txt = txtArea.value.trim();
        if(!txt) return alert('Paste a JSON array of lexicon entries first');
        try{
            const arr = JSON.parse(txt);
            if(!Array.isArray(arr)) throw new Error('Not an array');
            lexicon = arr.concat(lexicon);
            renderLex();
            alert('Imported ' + arr.length + ' entries (now '+lexicon.length+' total)');
        } catch(err){ alert('JSON parse error: '+err.message); }
    });
});
</script>
</body>
</html>